'use strict';
const TelegramCliWrapper = require('./telegram-cli-wrapper.js');
const APIConnection = require('./models/APIConnection.js');

class TelegramAPI {
  constructor(config) {
    this.child = null;
    this.socket = null;
    this.connection = null;
    this.tgcli = new TelegramCliWrapper(config);
  }
  
  connect(callback) {
    if(this.tgcli.isRunning()){
      throw new Error('TelegramAPI is already running');
    }
    
    this.tgcli.start((socket, child) => {
      this.connection = new APIConnection(socket);
      this.socket = socket;
      this.child = child;

      this.socket.writeLine('main_session');

      callback(this.connection, this.child);
    });
  }
  
  disconnect() {
    this.tgcli.stop();
    if(this.connection){
      this.connection.close();
      this.connection = null;
    }
  }
}

module.exports = TelegramAPI;